#!/usr/bin/env bash
set -e

usage() {
  echo "Usage: senv [-e | -d]"
}

options=()
arguments=()
for arg in "$@"; do
  if [ "${arg:0:1}" = "-" ]; then
    if [ "${arg:1:1}" = "-" ]; then
      options[${#options[*]}]="${arg:2}"
    else
      index=1
      while option="${arg:$index:1}"; do
        [ -n "$option" ] || break
        options[${#options[*]}]="$option"
        let index+=1
      done
    fi
  else
    arguments[${#arguments[*]}]="$arg"
  fi
done

# detect default ssh identity (~/.ssh/id_rsa)
# identity=$(ssh-add -l | awk -F ' ' '{print $3}')
identity="${BATS_TEST_DIRNAME}/id_rsa"

unset encrypt decrypt

for option in "${options[@]}"; do
  case "$option" in
  "e" | "encrypt" )
    encrypt="1"
    ;;
  "d" | "decrypt" )
    decrypt="1"
    ;;
  "i" | "identity" )
    identity="$OPTARG"
    ;;
  "w" | "write" )
    write="1"
    ;;
  * )
    usage >&2
    exit 1
    ;;
  esac
done

if [ -n "$encrypt" ]; then
  file="./.env"
  tmppubkey="/tmp/identity.pub.pem"
  openssl rsa -in $identity -pubout > "$tmppubkey" 2>/dev/null
  cat $file | openssl rsautl -encrypt -pubin -inkey "$tmppubkey" | openssl base64 -A
  echo
  exit 0
fi

if [ -n "$decrypt" ]; then
  file="./.senv"
  cat $file | openssl base64 -A -d | openssl rsautl -decrypt -inkey $identity
  exit 0
fi

usage >&2
exit 1
